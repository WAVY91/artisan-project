<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .sidebar-bg {
            background-color: #0d1e3a;
        }

        .text-primary-navy {
            color: #0d1e3a;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
        }

        body::-webkit-scrollbar {
            width: 8px;
        }

        body::-webkit-scrollbar-thumb {
            background-color: #0d1e3a;
            border-radius: 4px;
        }

        .main-content {
            transition: margin-left 0.3s ease;
        }

        .max-w-xs {
            max-width: 12rem;
        }

        .admin-table-header {
            background-color: #212529;
            color: white;
            font-weight: 600;
        }

        body {
            background-color: #eef2f8;
            font-family: 'Inter', sans-serif;
        }

        .main-content {
            min-height: 100vh;
        }

        .card-base {
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: white;
            min-height: 150px;
        }

        .card-artisans {
            background: linear-gradient(135deg, #7c98e8 0%, #4a68c0 100%);
        }

        .card-customers {
            background: linear-gradient(135deg, #a485f7 0%, #7d52f8 100%);
        }

        .card-services {
            background: linear-gradient(135deg, #f7d28c 0%, #f5b95a 100%);
        }

        .card-bookings {
            background: linear-gradient(135deg, #f48083 0%, #f15256 100%);
        }

        .card-contacts {
            background: linear-gradient(135deg, #8fe09b 0%, #63c070 100%);
        }

        .card-questions {
            background: linear-gradient(135deg, #7ad8e8 0%, #46b7c9 100%);
        }

        .card-content {
            position: relative;
            z-index: 10;
        }

        .trend-line {
            position: absolute;
            bottom: -5px;
            right: 0;
            width: 100%;
            height: 50px;
            border-top: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
        }

        .chart-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .bar-chart-placeholder {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            height: 200px;
            align-items: flex-end;
            gap: 10px;
            padding-bottom: 20px;
            border-left: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        .bar {
            width: 100%;
            background-color: #7d52f8;
            opacity: 0.8;
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.3s;
        }

        .bar-team-a {
            background-color: #4a68c0;
            margin-right: -5px;
            z-index: 5;
        }

        .bar-pair {
            display: flex;
            align-items: flex-end;
            height: 100%;
            position: relative;
        }

        .nav-active {
            background: linear-gradient(90deg, #4a68c0 0%, #7c98e8 100%);
            box-shadow: 0 2px 8px rgba(74, 104, 192, 0.5);
        }

        #modalMessage {
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            word-break: break-word;
        }
    </style>
</head>

<body class="flex min-h-screen">

    <aside id="sidebar"
        class="sidebar-bg w-64 flex-shrink-0 min-h-screen text-white shadow-xl fixed md:static transition-transform duration-300 transform -translate-x-full md:translate-x-0 z-20">
        <div class="p-6 border-b border-gray-700">
            <h1 class="text-xl font-semibold">Admin Panel</h1>
            <p id="adminGreeting" class="text-sm text-white/70 mt-1">Welcome back, Admin!</p>
        </div>
        <nav class="flex flex-col p-2 space-y-2">
            <button onclick="navigateTo('dashboard')" id="nav-dashboard"
                class="flex items-center p-3 text-lg font-medium rounded-lg hover:bg-indigo-700 transition duration-150 nav-active">
                Dashboard
            </button>
            <button onclick="navigateTo('artisans')" id="nav-artisans"
                class="flex items-center p-3 text-lg font-medium rounded-lg hover:bg-indigo-700 transition duration-150">
                Artisans
            </button>
            <button onclick="navigateTo('customers')" id="nav-customers"
                class="flex items-center p-3 text-lg font-medium rounded-lg hover:bg-indigo-700 transition duration-150">
                Customers
            </button>
            <button onclick="navigateTo('contactinfos')" id="nav-contactinfos"
                class="flex items-center p-3 text-lg font-medium rounded-lg hover:bg-indigo-700 transition duration-150">
                Customer Contacts
            </button>
            <button onclick="navigateTo('questions')" id="nav-questions"
                class="flex items-center p-3 text-lg font-medium rounded-lg hover:bg-indigo-700 transition duration-150">
                Customer Questions
            </button>
            <button onclick="navigateTo('banned')" id="nav-banned"
                class="flex items-center p-3 text-lg font-medium rounded-lg hover:bg-indigo-700 transition duration-150">
                Banned Users
            </button>
            <button onclick="navigateTo('services')" id="nav-services"
                class="flex items-center p-3 text-lg font-medium rounded-lg hover:bg-indigo-700 transition duration-150">
                Services
            </button>
            <button onclick="navigateTo('bookings')" id="nav-bookings"
                class="flex items-center p-3 text-lg font-medium rounded-lg hover:bg-indigo-700 transition duration-150">
                Bookings
            </button>
            <button onclick="navigateTo('settings')" id="nav-settings"
                class="flex items-center p-3 text-lg font-medium rounded-lg hover:bg-indigo-700 transition duration-150">
                Settings
            </button>
            <button onclick="logoutAdmin()"
                class="flex items-center p-3 text-lg font-medium rounded-lg hover:bg-red-700 transition duration-150 mt-6 bg-red-600">
                Logout
            </button>
        </nav>
    </aside>

    <main id="mainContent" class="main-content flex-grow p-4 md:p-8">
        <button id="menuToggle" class="md:hidden p-2 rounded-lg bg-gray-200 text-gray-800 mb-4 focus:outline-none">
            â˜°
        </button>

        <h2 id="currentTitle" class="text-3xl font-bold mb-6 text-gray-800">Dashboard</h2>

        <div id="dashboardView" class="grid grid-cols-1 gap-6">

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">

                <div class="card-base card-artisans flex flex-col justify-between">
                    <div class="card-content flex justify-between items-start">
                        <h3 class="text-lg font-medium text-white/90">Artisans</h3>
                        <span
                            class="text-sm font-semibold text-white/90 bg-white/20 px-2 py-0.5 rounded-full">+3.5%</span>
                    </div>
                    <div class="card-content mt-4">
                        <p id="statArtisans" class="stat-value">0</p>
                        <p class="text-sm text-white/80">Active Workers</p>
                    </div>
                    <div class="trend-line"></div>
                </div>

                <div class="card-base card-customers flex flex-col justify-between">
                    <div class="card-content flex justify-between items-start">
                        <h3 class="text-lg font-medium text-white/90">Customers</h3>
                        <span
                            class="text-sm font-semibold text-white/90 bg-white/20 px-2 py-0.5 rounded-full">-0.1%</span>
                    </div>
                    <div class="card-content mt-4">
                        <p id="statCustomers" class="stat-value">0</p>
                        <p class="text-sm text-white/80">Total Users</p>
                    </div>
                    <div class="trend-line"></div>
                </div>

                <div class="card-base card-services flex flex-col justify-between">
                    <div class="card-content flex justify-between items-start">
                        <h3 class="text-lg font-medium text-white/90">Services</h3>
                        <span
                            class="text-sm font-semibold text-white/90 bg-white/20 px-2 py-0.5 rounded-full">+2.8%</span>
                    </div>
                    <div class="card-content mt-4">
                        <p id="statServices" class="stat-value">12</p>
                        <p class="text-sm text-white/80">Available Categories</p>
                    </div>
                    <div class="trend-line"></div>
                </div>

                <div class="card-base card-bookings flex flex-col justify-between">
                    <div class="card-content flex justify-between items-start">
                        <h3 class="text-lg font-medium text-white/90">Bookings</h3>
                        <span
                            class="text-sm font-semibold text-white/90 bg-white/20 px-2 py-0.5 rounded-full">+3.6%</span>
                    </div>
                    <div class="card-content mt-4">
                        <p id="statBookings" class="stat-value">0</p>
                        <p class="text-sm text-white/80">Pending/Active</p>
                    </div>
                    <div class="trend-line"></div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:col-span-4 gap-6">
                    <div class="card-base card-contacts flex flex-col justify-between">
                        <div class="card-content flex justify-between items-start">
                            <h3 class="text-lg font-medium text-white/90">New Contacts</h3>
                            <span
                                class="text-sm font-semibold text-white/90 bg-white/20 px-2 py-0.5 rounded-full">+0.9%</span>
                        </div>
                        <div class="card-content mt-4">
                            <p id="statContacts" class="stat-value">0</p>
                            <p class="text-sm text-white/80">Unread Messages</p>
                        </div>
                        <div class="trend-line"></div>
                    </div>

                    <div class="card-base card-questions flex flex-col justify-between">
                        <div class="card-content flex justify-between items-start">
                            <h3 class="text-lg font-medium text-white/90">New Questions</h3>
                            <span
                                class="text-sm font-semibold text-white/90 bg-white/20 px-2 py-0.5 rounded-full">+1.2%</span>
                        </div>
                        <div class="card-content mt-4">
                            <p id="statQuestions" class="stat-value">0</p>
                            <p class="text-sm text-white/80">Customer Queries</p>
                        </div>
                        <div class="trend-line"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Top Service Categories</h3>
                    <div id="topServicesChart" class="space-y-3">
                        <div class="text-sm font-medium text-primary-navy">Plumbing <span
                                class="float-right text-gray-600">35%</span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-indigo-600 h-2.5 rounded-full" style="width: 35%"></div>
                        </div>

                        <div class="text-sm font-medium text-primary-navy">Tailoring <span
                                class="float-right text-gray-600">25%</span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-indigo-600 h-2.5 rounded-full" style="width: 25%"></div>
                        </div>

                        <div class="text-sm font-medium text-primary-navy">Tech Repair <span
                                class="float-right text-gray-600">15%</span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-indigo-600 h-2.5 rounded-full" style="width: 15%"></div>
                        </div>

                        <div class="text-sm font-medium text-primary-navy">Electrical <span
                                class="float-right text-gray-600">10%</span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-indigo-600 h-2.5 rounded-full" style="width: 10%"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Pending Actions</h3>
                    <div id="pendingActionsList" class="space-y-2 text-sm">
                        <p class="text-red-600 flex justify-between items-center">
                            <span>New Questions to Review</span>
                            <span id="pendingQuestionsCount" class="font-bold text-lg">0</span>
                        </p>
                        <p class="text-blue-600 flex justify-between items-center">
                            <span>New Contacts to Follow Up</span>
                            <span id="pendingContactsCount" class="font-bold text-lg">0</span>
                        </p>
                        <p class="text-yellow-600 flex justify-between items-center">
                            <span>Pending Bookings</span>
                            <span id="pendingBookingsCount" class="font-bold text-lg">0</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div id="artisansView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">Artisan List</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="admin-table-header">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">S/N</th>
                                <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Job Category</th>
                                <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Phone</th>
                                <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Mail</th>
                                <th class="px-6 py-3 text-center text-xs uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="artisanList" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-4 text-center text-gray-500 italic">Loading artisan
                                    data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="customersView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">Customer List</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="admin-table-header">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">S/N</th>
                                <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Phone</th>
                                <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Mail</th>
                                <th class="px-6 py-3 text-center text-xs uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customerList" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500 italic">Loading customer
                                    data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="bannedView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">Banned Users List</h3>
                <div id="bannedList">
                    <p class='text-gray-500 italic'>Loading banned users data...</p>
                </div>
            </div>
        </div>

        <div id="contactinfosView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">Customer Contact Messages</h3>
                <div id="contactList" class="overflow-x-auto">
                    <p class='text-gray-500 italic'>Loading customer messages...</p>
                </div>
            </div>
        </div>

        <div id="questionsView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">Customer Questions</h3>
                <div id="questionsList" class="overflow-x-auto">
                    <p class='text-gray-500 italic'>Loading customer questions...</p>
                </div>
            </div>
        </div>

        <div id="servicesView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">Service Management</h3>
                <div id="serviceList" class="space-y-4">
                    <p class='text-gray-500 italic'>This section will be used to create, edit, and delete the core
                        services offered by the platform/admins (e.g., "Plumbing Service," "Electrical Service").</p>
                    <div class="p-4 border border-blue-200 bg-blue-50 rounded-lg">
                        <p class="font-semibold text-blue-700">Example Service: Plumbing Repair</p>
                        <p class="text-sm text-gray-600">Category: Home Maintenance | Status: Active</p>
                        <button
                            class="mt-2 px-3 py-1 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-150">Edit
                            Service</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="bookingsView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">Customer Bookings Overview</h3>
                <div id="bookingList" class="space-y-4">
                    <p class='text-gray-500 italic'>Loading customer bookings and admin requests...</p>
                </div>
            </div>
        </div>

        <div id="settingsView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">Website Configuration Settings</h3>
                <div id="settingsContent" class="space-y-4">
                    <p class="font-semibold text-gray-800 border-b pb-2">General Configuration</p>

                    <div class="p-4 border rounded-lg space-y-3">
                        <div>
                            <label for="siteName" class="block text-sm font-medium text-gray-700">Site Name</label>
                            <input type="text" id="siteName" value="Artisan Booking App"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="maintenanceMode" class="block text-sm font-medium text-gray-700">Maintenance
                                Mode</label>
                            <select id="maintenanceMode"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                <option>Disabled</option>
                                <option>Enabled</option>
                            </select>
                        </div>
                    </div>

                    <button
                        class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">Save
                        Settings</button>
                </div>
            </div>
        </div>

    </main>

    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95">
            <h4 id="modalTitle" class="text-xl font-bold mb-3 text-red-600">Confirmation</h4>
            <p id="modalMessage" class="mb-5 text-gray-700 whitespace-pre-wrap"></p>
            <div id="modalActions" class="flex justify-end space-x-3">
                <button id="modalCancel"
                    class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="modalConfirm"
                    class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, get, remove, set } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const providedConfig = {
            apiKey: "AIzaSyDocTQeWER_kb6mxqNlmbv04M0339iaDDM",
            authDomain: "project-8bb29.firebaseapp.com",
            databaseURL: "https://project-8bb29-default-rtdb.firebaseio.com",
            projectId: "project-8bb29",
            storageBucket: "project-8bb29.firebasestorage.app",
            messagingSenderId: "792700267479",
            appId: "1:792700267479:web:d491f80fcd4c105faf3992",
            measurementId: "G-KY94VPFHX5",
        };
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(providedConfig));
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const db = getFirestore(app);

        setLogLevel('Debug');

        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(e => {
                console.error("Auth failed with custom token:", e);
                signInAnonymously(auth);
            });
        } else {
            signInAnonymously(auth);
        }

        let artisanCount = 0;
        let customerCount = 0;
        let contactCount = 0;
        let questionCount = 0;

        const modal = document.getElementById("customModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalMessage = document.getElementById("modalMessage");
        const modalActions = document.getElementById("modalActions");
        const modalCancel = document.getElementById("modalCancel");
        const modalConfirm = document.getElementById("modalConfirm");

        let resolveModalPromise;

        function showConfirm(title, message) {
            return new Promise(resolve => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalActions.classList.remove('justify-end');
                modalActions.classList.add('flex', 'justify-between');

                modalCancel.classList.remove('hidden');
                modalConfirm.classList.remove('hidden');

                modalConfirm.textContent = 'Confirm';
                modalTitle.className = 'text-xl font-bold mb-3 text-red-600';
                modalConfirm.className = 'px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700';
                modal.querySelector('.max-w-lg').classList.remove('max-w-sm');

                resolveModalPromise = resolve;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            });
        }

        function showAlert(title, message, isError = false) {
            return new Promise(resolve => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalActions.classList.add('justify-end');
                modalActions.classList.remove('flex', 'justify-between');

                modalCancel.classList.add('hidden');
                modalConfirm.classList.remove('hidden');
                modalConfirm.textContent = 'OK';

                modalTitle.className = isError ? 'text-xl font-bold mb-3 text-red-600' : 'text-xl font-bold mb-3 text-green-600';
                modalConfirm.className = isError ? 'px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700' : 'px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700';
                modal.querySelector('.max-w-lg').classList.remove('max-w-sm');

                resolveModalPromise = resolve;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            });
        }

        modalCancel.onclick = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            resolveModalPromise(false);
        };

        modalConfirm.onclick = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');

            if (modalConfirm.textContent === 'OK') {
                modalConfirm.textContent = 'Confirm';
                resolveModalPromise(true);
            } else {
                resolveModalPromise(true);
            }
        };

        const encodeEmail = (email) => btoa(email).replace(/[.#$/\[\]]/g, "_");

        async function addBannedEmail(email) {
            const bannedRef = ref(database, `bannedUsers/${encodeEmail(email)}`);
            await set(bannedRef, {
                email: email,
                bannedAt: new Date().toISOString(),
                reason: "Deleted by Admin"
            });
        }

        async function loadBookingsData() {
            const hireRef = ref(database, "hireRequests");
            const adminRef = ref(database, "adminRequests");
            const bookingList = document.getElementById("bookingList");
            bookingList.innerHTML = "<p class='text-gray-500 italic'>Fetching bookings and requests...</p>";

            try {
                const [hireSnap, adminSnap] = await Promise.all([get(hireRef), get(adminRef)]);

                let allBookings = [];

                if (hireSnap.exists()) {
                    Object.entries(hireSnap.val()).forEach(([key, data]) => {
                        const serviceLabel = data.serviceName || data.serviceType || data.service || 'N/A';
                        const dateValue = data.requestedAt || data.dateRequested || data.scheduledDate || data.date || data.createdAt || null;
                        const displayDate = dateValue ? (isNaN(Date.parse(dateValue)) ? String(dateValue) : new Date(dateValue).toLocaleString()) : 'N/A';

                        allBookings.push({
                            key: key,
                            type: 'Hire',
                            customerName: data.customerName || data.customerName || 'N/A (Missing Name)',
                            artisanName: data.artisanName || data.artisanName || 'N/A (Unassigned)',
                            service: serviceLabel,
                            status: data.status || 'Pending',
                            date: dateValue,
                            displayDate: displayDate,
                            data: data
                        });
                    });
                }

                if (adminSnap.exists()) {
                    Object.entries(adminSnap.val()).forEach(([key, data]) => {
                        allBookings.push({
                            key: key,
                            type: 'Admin',
                            customerName: data.name || 'N/A',
                            artisanName: 'N/A',
                            service: data.requestType || 'General Inquiry',
                            status: 'Closed',
                            date: data.date,
                            displayDate: data.date ? new Date(data.date).toLocaleDateString() : 'N/A',
                            data: data
                        });
                    });
                }

                allBookings.sort((a, b) => new Date(b.date) - new Date(a.date));

                const pendingCount = allBookings.filter(b => b.status === 'Pending').length;
                document.getElementById('statBookings').textContent = allBookings.length;
                document.getElementById('pendingBookingsCount').textContent = pendingCount;


                if (allBookings.length > 0) {
                    let tableHtml = `
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-gray-200">
<thead class="admin-table-header">
<tr>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Type</th>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Date</th>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Customer Name</th>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Artisan Name</th>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Service/Request</th>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Status</th>
<th class="px-6 py-3 text-center text-xs uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody class="bg-white divide-y divide-gray-200">
`;

                    allBookings.forEach((booking, index) => {
                        const statusColor = booking.status === 'Pending' ? 'text-yellow-600' : 'text-green-600';
                        const rowClass = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';

                        tableHtml += `
<tr class="${rowClass}">
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${booking.type}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${booking.displayDate}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${booking.customerName}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${booking.artisanName || 'N/A'}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${booking.service}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${statusColor}">${booking.status}</td>
<td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
<button onclick="viewBookingDetails('${booking.type}', '${booking.key}')" class="text-indigo-600 hover:text-indigo-900 mr-3">View</button>
<button onclick="deleteBookingRequest('${booking.type}', '${booking.key}')" class="text-red-600 hover:text-red-900">Delete</button>
</td>
</tr>
`;
                    });

                    tableHtml += `
</tbody>
</table>
</div>
`;
                    bookingList.innerHTML = tableHtml;

                } else {
                    bookingList.innerHTML = "<p class='text-gray-500 italic'>No customer bookings or admin requests found.</p>";
                }
            } catch (error) {
                console.error("Failed to load booking data:", error);
                bookingList.innerHTML = `<p class='text-red-500 italic'>Error loading data: ${error.message}</p>`;
            }
        }
        window.loadBookingsData = loadBookingsData;

        window.viewBookingDetails = async (type, key) => {
            const path = type === 'Hire' ? `hireRequests/${key}` : `adminRequests/${key}`;
            const detailsRef = ref(database, path);
            const snap = await get(detailsRef);

            if (snap.exists()) {
                const data = snap.val();
                let message = '';
                let title = '';

                if (type === 'Hire') {
                    const serviceLabel = data.serviceName || data.serviceType || data.service || 'N/A';
                    const requestedAt = data.requestedAt || data.date || data.createdAt || null;
                    const requestedAtLabel = requestedAt ? (isNaN(Date.parse(requestedAt)) ? String(requestedAt) : new Date(requestedAt).toLocaleString()) : 'N/A';

                    title = `Hire Request: ${serviceLabel}`;
                    message = `Customer: ${data.customerName || 'N/A'}\nArtisan: ${data.artisanName || 'N/A (Unassigned)'}\nStatus: ${data.status || 'Pending'}\n\nPhone: ${data.customerPhone || 'N/A'}\nEmail: ${data.customerEmail || 'N/A'}\n\nRequested At: ${requestedAtLabel}\nService: ${serviceLabel}\nPrice: ${data.price != null ? data.price : 'N/A'}\nNote: ${data.note || data.description || 'N/A'}\n\nAddress: ${data.address || 'N/A'}`;
                } else if (type === 'Admin') {
                    title = `Admin Request: ${data.requestType || 'General'}`;
                    message = `Name: ${data.name || 'N/A'}\nEmail: ${data.email || 'N/A'}\nDate: ${new Date(data.date).toLocaleString()}\n\nMessage:\n${data.message || 'N/A'}`;
                }

                await showAlert(title, message, false);
            } else {
                showAlert("Error", "Request details not found.", true);
            }
        };

        window.deleteBookingRequest = async (type, key) => {
            const isConfirmed = await showConfirm(
                "Confirm Deletion",
                `Are you sure you want to delete this ${type} request permanently? This cannot be undone.`
            );

            if (!isConfirmed) return;

            try {
                const path = type === 'Hire' ? `hireRequests/${key}` : `adminRequests/${key}`;
                await remove(ref(database, path));
                await showAlert("Success!", `${type} request deleted successfully.`);
                loadBookingsData();
            } catch (error) {
                console.error("Deletion failed:", error);
                showAlert("Error", `Failed to delete request: ${error.message}`, true);
            }
        };


        async function loadContactInfos() {
            const contactsRef = ref(database, "contactInfos");

            const contactsSnap = await get(contactsRef);

            const contactList = document.getElementById("contactList");
            contactList.innerHTML = "";

            const contacts = contactsSnap.exists() ? Object.entries(contactsSnap.val()) : [];
            contactCount = contacts.length;

            if (contacts.length > 0) {
                let tableHtml = `
<table class="min-w-full divide-y divide-gray-200">
<thead class="admin-table-header">
<tr>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Date</th>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Name</th>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Email</th>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Subject</th>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Message</th>
<th class="px-6 py-3 text-center text-xs uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody class="bg-white divide-y divide-gray-200">
`;

                contacts.reverse().forEach(([key, data]) => {
                    const messageContent = data.comment || data.message || 'N/A';
                    const messageSnippet = messageContent.length > 50 ? messageContent.substring(0, 47) + '...' : messageContent;
                    const date = data.date ? new Date(data.date).toLocaleDateString() : 'N/A';

                    tableHtml += `
<tr id="contact-row-${key}">
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${data.name || 'N/A'}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">${data.email || 'N/A'}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.subject || 'N/A'}</td>
<td class="px-6 py-4 text-sm text-gray-700 max-w-xs overflow-hidden truncate" title="${messageContent}">${messageSnippet}</td>
<td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
<button onclick="viewContactMessage('${key}')" class="text-indigo-600 hover:text-indigo-900 mr-3">View</button>
<button onclick="deleteContactMessage('${key}')" class="text-red-600 hover:text-red-900">Delete</button>
</td>
</tr>
`;
                });

                tableHtml += `
</tbody>
</table>
`;
                contactList.innerHTML = tableHtml;

            } else {
                contactList.innerHTML = "<p class='text-gray-500 italic'>No customer contact messages found.</p>";
            }

            document.getElementById('statContacts').textContent = contactCount;
            document.getElementById('pendingContactsCount').textContent = contactCount;
        }
        window.loadContactInfos = loadContactInfos;

        window.viewContactMessage = async (key) => {
            const contactsRef = ref(database, `contactInfos/${key}`);
            const snap = await get(contactsRef);

            if (snap.exists()) {
                const data = snap.val();
                const messageContent = data.comment || data.message || 'No message content.';
                await showAlert(
                    `Message from ${data.name || 'Customer'} (${data.email || 'No Email'})`,
                    `Subject: ${data.subject || 'N/A'}\n\nPhone: ${data.number || 'N/A'}\n\nMessage:\n${messageContent}`,
                    false
                );
            } else {
                showAlert("Error", "Contact message not found.", true);
            }
        };

        window.deleteContactMessage = async (key) => {
            const isConfirmed = await showConfirm(
                "Confirm Deletion",
                "Are you sure you want to delete this contact message? This cannot be undone."
            );

            if (!isConfirmed) return;

            try {
                const contactsRef = ref(database, `contactInfos/${key}`);
                await remove(contactsRef);
                await showAlert("Success!", "Contact message deleted successfully.");
                loadContactInfos();
            } catch (error) {
                console.error("Deletion failed:", error);
                showAlert("Error", `Failed to delete message: ${error.message}`, true);
            }
        };

        async function loadQuestions() {
            const questionsRef = ref(database, "Questions");
            const questionsSnap = await get(questionsRef);
            const questionsList = document.getElementById("questionsList");
            questionsList.innerHTML = "";

            const questions = questionsSnap.exists() ? Object.entries(questionsSnap.val()) : [];
            questionCount = questions.length;

            if (questions.length > 0) {
                let tableHtml = `
<table class="min-w-full divide-y divide-gray-200">
<thead class="admin-table-header">
<tr>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Date</th>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Name</th>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Question Snippet</th>
<th class="px-6 py-3 text-center text-xs uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody class="bg-white divide-y divide-gray-200">
`;

                questions.reverse().forEach(([key, data]) => {
                    const questionContent = data.question || 'N/A';
                    const questionSnippet = questionContent.length > 50 ? questionContent.substring(0, 47) + '...' : questionContent;
                    const date = data.date ? new Date(data.date).toLocaleDateString() : 'N/A';

                    tableHtml += `
<tr id="question-row-${key}">
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${data.name || 'N/A'}</td>
<td class="px-6 py-4 text-sm text-gray-700 max-w-xs overflow-hidden truncate" title="${questionContent}">${questionSnippet}</td>
<td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
<button onclick="viewQuestion('${key}')" class="text-indigo-600 hover:text-indigo-900 mr-3">View</button>
<button onclick="deleteQuestion('${key}')" class="text-red-600 hover:text-red-900">Delete</button>
</td>
</tr>
`;
                });

                tableHtml += `
</tbody>
</table>
`;
                questionsList.innerHTML = tableHtml;

            } else {
                questionsList.innerHTML = "<p class='text-gray-500 italic'>No customer questions found.</p>";
            }

            document.getElementById('statQuestions').textContent = questionCount;
            document.getElementById('pendingQuestionsCount').textContent = questionCount;
        }
        window.loadQuestions = loadQuestions;

        window.viewQuestion = async (key) => {
            const questionsRef = ref(database, `Questions/${key}`);
            const snap = await get(questionsRef);

            if (snap.exists()) {
                const data = snap.val();
                const questionContent = data.question || 'No question content.';
                await showAlert(
                    `Question from ${data.name || 'Customer'} (${data.email || 'No Email'})`,
                    `Question:\n${questionContent}`,
                    false
                );
            } else {
                showAlert("Error", "Question message not found.", true);
            }
        };

        window.deleteQuestion = async (key) => {
            const isConfirmed = await showConfirm(
                "Confirm Deletion",
                "Are you sure you want to delete this question? This cannot be undone."
            );

            if (!isConfirmed) return;

            try {
                const questionsRef = ref(database, `Questions/${key}`);
                await remove(questionsRef);
                await showAlert("Success!", "Question message deleted successfully.");
                loadQuestions();
            } catch (error) {
                console.error("Deletion failed:", error);
                showAlert("Error", `Failed to delete question: ${error.message}`, true);
            }
        };

        window.logoutAdmin = async () => {
            const isConfirmed = await showConfirm(
                "Confirm Logout",
                "Are you sure you want to log out of the Admin Panel?"
            );

            if (!isConfirmed) return;

            try {
                await signOut(auth);
                document.getElementById('mainContent').innerHTML = `
<div class="p-10 text-center">
<h2 class="text-4xl font-bold text-gray-800 mb-4">Logged Out Successfully</h2>
<p class="text-gray-600">Please refresh the page to sign in again.</p>
</div>
`;
                document.getElementById('sidebar').classList.add('hidden');
                showAlert("Logout Successful", "You have been logged out.");
                setTimeout(() => {
                    window.location.href = 'index.html'
                }, 4500)
            } catch (error) {
                console.error("Logout failed:", error);
                showAlert("Logout Error", `Failed to log out: ${error.message}`, true);
            }
        };

        window.unbanEmail = async (email) => {
            try {
                const bannedRef = ref(database, `bannedUsers/${encodeEmail(email)}`);
                await remove(bannedRef);
                await showAlert("Success!", `${email} has been unbanned successfully.`);
                loadBannedUsers();
                loadUsers();
            } catch (error) {
                console.error("Unban failed:", error);
                showAlert("Error", `Failed to unban ${email}. Check console for details.`, true);
            }
        };

        async function loadBannedUsers() {
            const bannedRef = ref(database, "bannedUsers");
            const bannedSnap = await get(bannedRef);
            const bannedList = document.getElementById("bannedList");
            bannedList.innerHTML = "";

            const bannedUsers = bannedSnap.exists() ? Object.values(bannedSnap.val()) : [];

            if (bannedUsers.length > 0) {
                let tableHtml = `
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-gray-200">
<thead class="admin-table-header">
<tr>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">S/N</th>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Email</th>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Banned At</th>
<th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Reason</th>
<th class="px-6 py-3 text-center text-xs uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody class="bg-white divide-y divide-gray-200">
`;

                bannedUsers.forEach((user, index) => {
                    const date = new Date(user.bannedAt).toLocaleString();
                    const reason = user.reason || 'Not specified';
                    const rowClass = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';

                    tableHtml += `
<tr class="${rowClass}">
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-600">${user.email}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${date}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${reason}</td>
<td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
<button class="px-3 py-1 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-150"
onclick="unbanEmail('${user.email}')">Unban</button>
</td>
</tr>
`;
                });

                tableHtml += `
</tbody>
</table>
</div>
`;
                bannedList.innerHTML = tableHtml;
            } else {
                bannedList.innerHTML = "<p class='text-gray-500 italic'>No banned users.</p>";
            }
        }


        async function loadUsers() {
            const artisanRef = ref(database, "allArtisans");
            const customerRef = ref(database, "customers");

            const [artisanSnap, customerSnap] = await Promise.all([get(artisanRef), get(customerRef)]);

            const artisans = artisanSnap.exists() ? Object.entries(artisanSnap.val()) : [];
            artisanCount = artisans.length;

            const artisanListBody = document.getElementById("artisanList");
            artisanListBody.innerHTML = "";

            if (artisans.length > 0) {
                artisans.forEach(([id, data], index) => {
                    const fullName = `${data.firstName || "N/A"} ${data.lastName || "N/A"}`;
                    const skill = data.jobCategory || data.job || data.selectJob || data.jobDescription || "Not provided";
                    const phone = data.phoneNum || data.phoneNumber || data.phone || data.WhatsappNumber || data.whatsappNumber || "Not provided";
                    const email = data.email || "N/A";
                    const registrationDateRaw = data.registeredAt || data.registeredAtTimestamp || data.date || data.createdAt || null;
                    const registrationDate = registrationDateRaw ? (isNaN(Date.parse(registrationDateRaw)) ? String(registrationDateRaw) : new Date(registrationDateRaw).toLocaleDateString()) : 'N/A';

                    const row = document.createElement("tr");
                    row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                    row.innerHTML = `
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registrationDate}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${fullName}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${skill}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${phone}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">${email}</td>
<td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
<button class="px-3 py-1 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150"
onclick="deleteUserAccount('${id}', '${email}', 'artisan')">Delete (Auth & DB)</button>
</td>
`;
                    artisanListBody.appendChild(row);
                });
            } else {
                artisanListBody.innerHTML = `
<tr>
<td colspan="7" class="px-6 py-4 text-center text-gray-500 italic">No artisans found.</td>
</tr>
`;
            }
            const customerListBody = document.getElementById("customerList");
            customerListBody.innerHTML = "";
            const customers = customerSnap.exists() ? Object.entries(customerSnap.val()) : [];
            customerCount = customers.length;

            if (customers.length > 0) {
                customers.forEach(([id, data], index) => {
                    const fullName = `${data.firstName || "N/A"} ${data.lastName || "N/A"}`;
                    const phone = data.phoneNum || data.phoneNumber || data.phone || data.WhatsappNumber || data.whatsappNumber || "Not provided";
                    const email = data.email || "N/A";
                    const registrationDateRaw = data.registeredAt || data.registeredAtTimestamp || data.date || data.createdAt || null;
                    const registrationDate = registrationDateRaw ? (isNaN(Date.parse(registrationDateRaw)) ? String(registrationDateRaw) : new Date(registrationDateRaw).toLocaleDateString()) : 'N/A';

                    const row = document.createElement("tr");
                    row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                    row.innerHTML = `
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registrationDate}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${fullName}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${phone}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">${email}</td>
<td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
<button class="px-3 py-1 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150"
onclick="deleteUserAccount('${id}', '${email}', 'customer')">Delete</button>
</td>
`;
                    customerListBody.appendChild(row);
                });
            } else {
                customerListBody.innerHTML = `
<tr>
<td colspan="6" class="px-6 py-4 text-center text-gray-500 italic">No customers found.</td>
</tr>
`;
            }
            document.getElementById('statArtisans').textContent = artisanCount;
            document.getElementById('statCustomers').textContent = customerCount;
        }

        window.deleteUserAccount = async (uid, email, type) => {
            const isConfirmed = await showConfirm(
                "Confirm Deletion",
                `Are you sure you want to delete ${email} and automatically ban them? This action cannot be undone.`
            );

            if (!isConfirmed) return;

            try {
                const path = type === "artisan" ? `allArtisans/${uid}` : `customers/${uid}`;
                await remove(ref(database, path));
                await addBannedEmail(email);
                await showAlert("Success!", `${email} deleted and banned successfully!`);
                loadUsers();
                loadBannedUsers();
            } catch (error) {
                console.error(error);
                showAlert("Error", `Error deleting user: ${error.message}`, true);
            }
        };

        async function loadAdminName(uid) {
            const adminRef = ref(database, `Admins/${uid}`);
            const adminSnap = await get(adminRef);
            const greetingElement = document.getElementById('adminGreeting');

            if (adminSnap.exists()) {
                const adminData = adminSnap.val();
                const adminFirstName = adminData.firstName || "Admin";
                greetingElement.textContent = `Welcome back, ${adminFirstName}!`;
            } else {
                greetingElement.textContent = `Welcome back, Admin!`;
            }
        }

        const views = {
            'dashboard': 'Dashboard',
            'artisans': 'Artisan List',
            'customers': 'Customer List',
            'contactinfos': 'Customer Contact Messages',
            'questions': 'Customer Questions',
            'banned': 'Banned Users List',
            'services': 'Service Management',
            'bookings': 'Customer Bookings',
            'settings': 'Website Settings'
        };
        const viewElements = {
            'dashboard': document.getElementById('dashboardView'),
            'artisans': document.getElementById('artisansView'),
            'customers': document.getElementById('customersView'),
            'contactinfos': document.getElementById('contactinfosView'),
            'questions': document.getElementById('questionsView'),
            'banned': document.getElementById('bannedView'),
            'services': document.getElementById('servicesView'),
            'bookings': document.getElementById('bookingsView'),
            'settings': document.getElementById('settingsView')
        };

        const currentTitle = document.getElementById('currentTitle');

        window.navigateTo = (viewName) => {
            Object.values(viewElements).forEach(el => el.classList.add('hidden'));

            viewElements[viewName].classList.remove('hidden');
            currentTitle.textContent = views[viewName];

            Object.keys(views).forEach(key => {
                const navButton = document.getElementById(`nav-${key}`);
                if (key === viewName) {
                    navButton.classList.add('nav-active');
                    navButton.classList.remove('bg-indigo-700');
                } else {
                    navButton.classList.remove('nav-active');
                    navButton.classList.remove('bg-indigo-700');
                }
            });

            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
            }

            if (viewName === 'banned') {
                loadBannedUsers();
            } else if (viewName === 'bookings') {
                loadBookingsData();
            } else if (viewName === 'contactinfos') {
                loadContactInfos();
            } else if (viewName === 'questions') {
                loadQuestions();
            } else if (viewName === 'artisans' || viewName === 'customers') {
                loadUsers();
            }
        };

        document.getElementById('menuToggle').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        });

        const initializeDashboard = async () => {
            console.log("Authentication successful. Initializing dashboard data...");
            await Promise.all([
                loadUsers(),
                loadBannedUsers(),
                loadContactInfos(),
                loadQuestions(),
                loadBookingsData()
            ]);
            navigateTo('dashboard');
        };

        auth.onAuthStateChanged(async user => {
            if (user) {
                const adminRef = ref(database, `Admins/${user.uid}`);
                const adminSnap = await get(adminRef);

                if (!adminSnap.exists()) {
                    await set(adminRef, {
                        firstName: (user.email || 'NewAdmin').split('@')[0].split('.')[0],
                        lastName: "",
                        email: user.email || "admin@example.com",
                        uid: user.uid
                    });
                }

                await loadAdminName(user.uid);

                initializeDashboard();
            } else {
                console.warn("No user object found during initial auth check. Waiting or forcing sign-in...");
            }
        });

    </script>
</body>

</html>